{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"workspaceName": {
			"type": "string",
			"metadata": "Workspace name",
			"defaultValue": "donflamingo"
		},
		"AzureDataLakeStorageFinalStorage_accountKey": {
			"type": "secureString",
			"metadata": "Secure string for 'accountKey' of 'AzureDataLakeStorageFinalStorage'"
		},
		"donflamingo-WorkspaceDefaultSqlServer_connectionString": {
			"type": "secureString",
			"metadata": "Secure string for 'connectionString' of 'donflamingo-WorkspaceDefaultSqlServer'",
			"defaultValue": "Integrated Security=False;Encrypt=True;Connection Timeout=30;Data Source=tcp:donflamingo.sql.azuresynapse.net,1433;Initial Catalog=@{linkedService().DBName}"
		},
		"AzureDataLakeStorageFinalStorage_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://freefinalstorageaccount.dfs.core.windows.net/"
		},
		"donflamingo-WorkspaceDefaultStorage_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://synapsestorage348.dfs.core.windows.net"
		}
	},
	"variables": {
		"workspaceId": "[concat('Microsoft.Synapse/workspaces/', parameters('workspaceName'))]"
	},
	"resources": [
		{
			"name": "[concat(parameters('workspaceName'), '/AzureDataLakeStorageFinalStorage')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"annotations": [],
				"type": "AzureBlobFS",
				"typeProperties": {
					"url": "[parameters('AzureDataLakeStorageFinalStorage_properties_typeProperties_url')]",
					"accountKey": {
						"type": "SecureString",
						"value": "[parameters('AzureDataLakeStorageFinalStorage_accountKey')]"
					}
				},
				"connectVia": {
					"referenceName": "AutoResolveIntegrationRuntime",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/donflamingo-WorkspaceDefaultSqlServer')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"parameters": {
					"DBName": {
						"type": "String"
					}
				},
				"annotations": [],
				"type": "AzureSqlDW",
				"typeProperties": {
					"connectionString": "[parameters('donflamingo-WorkspaceDefaultSqlServer_connectionString')]"
				},
				"connectVia": {
					"referenceName": "AutoResolveIntegrationRuntime",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/donflamingo-WorkspaceDefaultStorage')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"annotations": [],
				"type": "AzureBlobFS",
				"typeProperties": {
					"url": "[parameters('donflamingo-WorkspaceDefaultStorage_properties_typeProperties_url')]"
				},
				"connectVia": {
					"referenceName": "AutoResolveIntegrationRuntime",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/AutoResolveIntegrationRuntime')]",
			"type": "Microsoft.Synapse/workspaces/integrationRuntimes",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"type": "Managed",
				"typeProperties": {
					"computeProperties": {
						"location": "AutoResolve",
						"dataFlowProperties": {
							"computeType": "General",
							"coreCount": 8,
							"timeToLive": 0
						}
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/WorkspaceSystemIdentity')]",
			"type": "Microsoft.Synapse/workspaces/credentials",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"type": "ManagedIdentity",
				"typeProperties": {}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/External table creation script')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"content": {
					"query": "\nCREATE EXTERNAL DATA SOURCE Patient_Data_Source\nWITH(\n    LOCATION='abfss://output@freefinalstorageaccount.dfs.core.windows.net'\n    );\n\nIF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'SynapseDelimitedTextFormat') \n\tCREATE EXTERNAL FILE FORMAT [SynapseDelimitedTextFormat] \n\tWITH ( FORMAT_TYPE = DELIMITEDTEXT ,\n\t       FORMAT_OPTIONS (\n\t\t\t FIELD_TERMINATOR = ',',\n\t\t\t FIRST_ROW = 1,\n\t\t\t USE_TYPE_DEFAULT = FALSE\n\t\t\t))\nGO\n\nCREATE EXTERNAL TABLE Patient\n(\n    [Patient_ID] bigint,\n\t[Name] nvarchar(4000),\n\t[Age] bigint,\n\t[Gender] nvarchar(4000),\n\t[Contact_Info] nvarchar(4000),\n\t[Medical_History] nvarchar(4000),\n\t[Active_Flag] nvarchar(4000)\n)\nWITH\n(\n    LOCATION='raw/patient/Dim_Patient_Large.csv',\n    DATA_SOURCE=Patient_Data_Source,\n    FILE_FORMAT=[SynapseDelimitedTextFormat]\n);\n\nSELECT top 10 * FROM dbo.Patient;\n",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "raw",
						"poolName": "Built-in"
					},
					"resultLimit": -1
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/read_from_files_script')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"content": {
					"query": "SELECT TOP 10 * FROM\nOPENROWSET(\n    BULK ('abfss://output@freefinalstorageaccount.dfs.core.windows.net/raw/patient/Dim_Patient_Large.csv',\n    'https://freefinalstorageaccount.blob.core.windows.net/output/raw/patient/Dim_Patient_Large.csv'),\n    FORMAT ='CSV',\n    PARSER_VERSION='2.0',\n    HEADER_ROW=TRUE\n) AS R",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "master",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/view_creation')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"content": {
					"query": "CREATE VIEW dbo.Patient AS\nSELECT * FROM\nOPENROWSET(\n    BULK ('abfss://output@freefinalstorageaccount.dfs.core.windows.net/raw/patient/Dim_Patient_Large.csv',\n    'https://freefinalstorageaccount.blob.core.windows.net/output/raw/patient/Dim_Patient_Large.csv'),\n    FORMAT ='CSV',\n    PARSER_VERSION='2.0',\n    HEADER_ROW=TRUE\n) AS R;\n\nSELECT * FROM dbo.Patient;",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "raw",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/ICU_Patient_7_Days_Reminder_Call_ETL')]",
			"type": "Microsoft.Synapse/workspaces/notebooks",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"nbformat": 4,
				"nbformat_minor": 2,
				"bigDataPool": {
					"referenceName": "BigDataDev",
					"type": "BigDataPoolReference"
				},
				"sessionProperties": {
					"driverMemory": "28g",
					"driverCores": 4,
					"executorMemory": "28g",
					"executorCores": 4,
					"numExecutors": 2,
					"runAsWorkspaceSystemIdentity": false,
					"conf": {
						"spark.dynamicAllocation.enabled": "false",
						"spark.dynamicAllocation.minExecutors": "2",
						"spark.dynamicAllocation.maxExecutors": "2",
						"spark.autotune.trackingId": "bc546cd2-8a16-4916-9fd7-2018df9e042f"
					}
				},
				"metadata": {
					"saveOutput": true,
					"enableDebugMode": false,
					"kernelspec": {
						"name": "synapse_pyspark",
						"display_name": "python"
					},
					"language_info": {
						"name": "python"
					},
					"a365ComputeOptions": {
						"id": "/subscriptions/2075028d-e3d3-4030-84e2-bb118eb5f397/resourceGroups/synapse_rg/providers/Microsoft.Synapse/workspaces/donflamingo/bigDataPools/BigDataDev",
						"name": "BigDataDev",
						"type": "Spark",
						"endpoint": "https://donflamingo.dev.azuresynapse.net/livyApi/versions/2019-11-01-preview/sparkPools/BigDataDev",
						"auth": {
							"type": "AAD",
							"authResource": "https://dev.azuresynapse.net"
						},
						"sparkVersion": "3.4",
						"nodeCount": 10,
						"cores": 4,
						"memory": 28
					},
					"sessionKeepAliveTimeout": 30
				},
				"cells": [
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"from pyspark.sql.types import StructType,StructField,StringType,IntegerType,DateType"
						],
						"outputs": [],
						"execution_count": 8
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"schema=StructType([StructField('Visit_ID',IntegerType(),True),\n",
							"StructField('Patient_ID',IntegerType(),True),\n",
							"StructField('Admission_Date',DateType(),True),\n",
							"StructField('Discharge_Date',DateType(),True),\n",
							"StructField('Doctor_ID',IntegerType(),True),\n",
							"StructField('Treatment_ID',IntegerType(),True),\n",
							"StructField('ICU_Stay',StringType(),True),\n",
							"StructField('Total_Cost',IntegerType(),True)])"
						],
						"outputs": [],
						"execution_count": 9
					},
					{
						"cell_type": "code",
						"source": [
							"visits_df=spark.read.option('header',True).schema(schema).csv('abfss://output@freefinalstorageaccount.dfs.core.windows.net/raw/visits/Fact_Patient_Visits_Large.csv')"
						],
						"outputs": [],
						"execution_count": 19
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"visits_df.show(20,truncate=False)"
						],
						"outputs": [],
						"execution_count": 12
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"patient_schema=StructType([StructField('Patient_ID',IntegerType(),True),\n",
							"StructField('Name',StringType(),True),\n",
							"StructField('Age',IntegerType(),True),\n",
							"StructField('Gender',StringType(),True),\n",
							"StructField('Contact_Info',StringType(),True),\n",
							"StructField('Medical_History',StringType(),True),\n",
							"StructField('Active_Flag',StringType(),True)])"
						],
						"outputs": [],
						"execution_count": 15
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"patient_df=spark.read.option('header',True).schema(patient_schema).csv('abfss://output@freefinalstorageaccount.dfs.core.windows.net/raw/patient/Dim_Patient_Large.csv')"
						],
						"outputs": [],
						"execution_count": 16
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"jnr_patient_visit_df=visits_df.join(patient_df,visits_df.Patient_ID==patient_df.Patient_ID,'inner').select(visits_df.ICU_Stay,visits_df.Discharge_Date,patient_df.Name,patient_df.Contact_Info)"
						],
						"outputs": [],
						"execution_count": 24
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"from pyspark.sql import functions as F"
						],
						"outputs": [],
						"execution_count": 25
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"ICU_released_patient_df=jnr_patient_visit_df.filter(\"ICU_Stay='Yes'\").withColumn('nextVisitDate',F.add_months(F.col('Discharge_Date'),1))"
						],
						"outputs": [],
						"execution_count": 30
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"ICU_released_patient_next_visit_reminder_call_df=ICU_released_patient_df.filter(F.col('nextVisitDate')==F.current_date()+7)"
						],
						"outputs": [],
						"execution_count": 40
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"ICU_released_patient_next_visit_reminder_call_df.write.mode('overwrite').csv('abfss://output@freefinalstorageaccount.dfs.core.windows.net/enterprise/patient/sevendays/reminderCalls/ICU_patinet_next_visits.csv')"
						],
						"outputs": [],
						"execution_count": 41
					}
				]
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/Load_Refine_Doctor')]",
			"type": "Microsoft.Synapse/workspaces/notebooks",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"nbformat": 4,
				"nbformat_minor": 2,
				"bigDataPool": {
					"referenceName": "BigDataDev",
					"type": "BigDataPoolReference"
				},
				"sessionProperties": {
					"driverMemory": "28g",
					"driverCores": 4,
					"executorMemory": "28g",
					"executorCores": 4,
					"numExecutors": 2,
					"conf": {
						"spark.dynamicAllocation.enabled": "false",
						"spark.dynamicAllocation.minExecutors": "2",
						"spark.dynamicAllocation.maxExecutors": "2",
						"spark.autotune.trackingId": "1eb0fd88-1f51-48a8-bf14-b4a246ad37ed"
					}
				},
				"metadata": {
					"saveOutput": true,
					"enableDebugMode": true,
					"kernelspec": {
						"name": "synapse_pyspark",
						"display_name": "Synapse PySpark"
					},
					"language_info": {
						"name": "python"
					},
					"a365ComputeOptions": {
						"id": "/subscriptions/2075028d-e3d3-4030-84e2-bb118eb5f397/resourceGroups/synapse_rg/providers/Microsoft.Synapse/workspaces/donflamingo/bigDataPools/BigDataDev",
						"name": "BigDataDev",
						"type": "Spark",
						"endpoint": "https://donflamingo.dev.azuresynapse.net/livyApi/versions/2019-11-01-preview/sparkPools/BigDataDev",
						"auth": {
							"type": "AAD",
							"authResource": "https://dev.azuresynapse.net"
						},
						"sparkVersion": "3.4",
						"nodeCount": 10,
						"cores": 4,
						"memory": 28
					},
					"sessionKeepAliveTimeout": 30
				},
				"cells": [
					{
						"cell_type": "markdown",
						"metadata": {
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"<center><b> This notebook is used to create doctor table in refine layer</b></center>\n",
							"<table>\n",
							"<tr><th>Title</th><th>Description</th></tr>\n",
							"<tr><td>Creator</td><td>Aniket Belsare</td></tr>\n",
							"<tr><td>Reviewer</td><td>Ankit Negi</td></tr>\n",
							"<tr><td>Datasets Used</td><td>/raw/doctor/Patient_YYYY_MM_DD.csv</td></tr>\n",
							"</table>"
						]
					},
					{
						"cell_type": "code",
						"source": [
							"from datetime import datetime,timedelta\n",
							"from notebookutils import mssparkutils"
						],
						"outputs": [],
						"execution_count": 2
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"from pyspark.sql.types import StructType, StructField, StringType, IntegerType, BooleanType\n",
							"from pyspark.sql import functions as F"
						],
						"outputs": [],
						"execution_count": 3
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"currentDate=datetime.today()-timedelta(days=1)\n",
							"currentDate=currentDate.strftime('%Y-%m-%d')"
						],
						"outputs": [],
						"execution_count": 5
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"fileName='Doctor'+'_'+currentDate"
						],
						"outputs": [],
						"execution_count": 6
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"\n",
							"rawDoctorDFSchema = StructType([\n",
							"    StructField(\"Doctor_ID\", IntegerType(), nullable=True),\n",
							"    StructField(\"Name\", StringType(), nullable=True),\n",
							"    StructField(\"Specialization\", StringType(), nullable=True),\n",
							"    StructField(\"Shift_Timing\", StringType(), nullable=True),\n",
							"    StructField(\"Contact_Info\", StringType(), nullable=True)\n",
							"])"
						],
						"outputs": [],
						"execution_count": 10
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"rawDoctorDF=spark.read.option(\"header\",True).schema(rawDoctorDFSchema).csv(f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/raw/doctor/{fileName}')"
						],
						"outputs": [],
						"execution_count": 11
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"rawDoctorDF.show(10)"
						],
						"outputs": [],
						"execution_count": 12
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"rawDoctorDF = rawDoctorDF.withColumn(\"Name\", \n",
							"                   F.when(rawDoctorDF.Name == 'None', None).otherwise(rawDoctorDF.Name)) \\\n",
							"                   .withColumn(\"Specialization\", \n",
							"                   F.when(rawDoctorDF.Specialization == 'None', None).otherwise(rawDoctorDF.Specialization)) \\\n",
							"                   .withColumn(\"Shift_Timing\", \n",
							"                   F.when(rawDoctorDF.Shift_Timing == 'None', None).otherwise(rawDoctorDF.Shift_Timing)) \\\n",
							"                   .withColumn(\"Contact_Info\", \n",
							"                   F.when(rawDoctorDF.Contact_Info == 'None', None).otherwise(rawDoctorDF.Contact_Info))"
						],
						"outputs": [],
						"execution_count": 17
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"refinedDoctorDF1=rawDoctorDF.fillna(0,['Doctor_ID']).fillna('Unknown',['Name']) \\\n",
							".fillna('Unknown',['Specialization']).fillna('000-000-0000',['Contact_Info']).fillna('Unknown',['Shift_Timing'])"
						],
						"outputs": [],
						"execution_count": 18
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"refinedDoctorDF2=refinedDoctorDF1.dropDuplicates(['Name','Specialization','Contact_Info'])"
						],
						"outputs": [],
						"execution_count": 19
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"refinedDoctorDFFinal=refinedDoctorDF2.withColumn('Contact_Info',F.concat(F.lit('+91 '),F.regexp_replace('Contact_Info','-',''))) \\\n",
							".withColumn('Contact_Info',F.regexp_replace('Contact_Info','x.','')) \\\n",
							".withColumn('Contact_Info',F.regexp_replace('Contact_Info','\\(','')) \\\n",
							".withColumn('Contact_Info',F.regexp_replace('Contact_Info','\\)','')) \\\n",
							".withColumn('Contact_Info',F.substring('Contact_Info',0,14)) \\\n",
							".withColumn('File_Name',F.lit(fileName))"
						],
						"outputs": [],
						"execution_count": 34
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"refinedDoctorDFFinal.write.format('parquet').save(f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/refine/doctor/table/')"
						],
						"outputs": [],
						"execution_count": 35
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"mssparkutils.fs.mkdirs(f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/archieve/doctor/{currentDate}')"
						],
						"outputs": [],
						"execution_count": 36
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"mssparkutils.fs.mv(f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/raw/doctor/{fileName}',f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/archieve/doctor/{currentDate}/')"
						],
						"outputs": [],
						"execution_count": 37
					}
				]
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/Load_Refine_Patient')]",
			"type": "Microsoft.Synapse/workspaces/notebooks",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"nbformat": 4,
				"nbformat_minor": 2,
				"bigDataPool": {
					"referenceName": "BigDataDev",
					"type": "BigDataPoolReference"
				},
				"sessionProperties": {
					"driverMemory": "28g",
					"driverCores": 4,
					"executorMemory": "28g",
					"executorCores": 4,
					"numExecutors": 2,
					"conf": {
						"spark.dynamicAllocation.enabled": "false",
						"spark.dynamicAllocation.minExecutors": "2",
						"spark.dynamicAllocation.maxExecutors": "2",
						"spark.autotune.trackingId": "6ae2d588-da26-48e8-9567-fee86c92cffb"
					}
				},
				"metadata": {
					"saveOutput": true,
					"enableDebugMode": false,
					"kernelspec": {
						"name": "synapse_pyspark",
						"display_name": "Synapse PySpark"
					},
					"language_info": {
						"name": "python"
					},
					"a365ComputeOptions": {
						"id": "/subscriptions/2075028d-e3d3-4030-84e2-bb118eb5f397/resourceGroups/synapse_rg/providers/Microsoft.Synapse/workspaces/donflamingo/bigDataPools/BigDataDev",
						"name": "BigDataDev",
						"type": "Spark",
						"endpoint": "https://donflamingo.dev.azuresynapse.net/livyApi/versions/2019-11-01-preview/sparkPools/BigDataDev",
						"auth": {
							"type": "AAD",
							"authResource": "https://dev.azuresynapse.net"
						},
						"sparkVersion": "3.4",
						"nodeCount": 10,
						"cores": 4,
						"memory": 28
					},
					"sessionKeepAliveTimeout": 30
				},
				"cells": [
					{
						"cell_type": "markdown",
						"metadata": {
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"<center><b> This notebook is used to create patient table in refine layer</b></center>\n",
							"<table>\n",
							"<tr><th>Title</th><th>Description</th></tr>\n",
							"<tr><td>Creator</td><td>Aniket Belsare</td></tr>\n",
							"<tr><td>Reviewer</td><td>Ankit Negi</td></tr>\n",
							"<tr><td>Datasets Used</td><td>/raw/patient/Patient_YYYY_MM_DD.csv</td></tr>\n",
							"</table>"
						]
					},
					{
						"cell_type": "code",
						"source": [
							"from datetime import datetime,timedelta\n",
							"from notebookutils import mssparkutils"
						],
						"outputs": [],
						"execution_count": 1
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"from pyspark.sql.types import StructType, StructField, StringType, IntegerType, BooleanType\n",
							"from pyspark.sql import functions as F"
						],
						"outputs": [],
						"execution_count": 7
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"currentDate=datetime.today()-timedelta(days=1)\n",
							"currentDate=currentDate.strftime('%Y-%m-%d')"
						],
						"outputs": [],
						"execution_count": 8
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"fileName='Patient'+'_'+currentDate"
						],
						"outputs": [],
						"execution_count": 9
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"\n",
							"rawPatientDFSchema = StructType([\n",
							"    StructField(\"Patient_ID\", IntegerType(), True),\n",
							"    StructField(\"Name\", StringType(), True),\n",
							"    StructField(\"Age\", IntegerType(), True),\n",
							"    StructField(\"Gender\", StringType(), True),\n",
							"    StructField(\"Contact_Info\", StringType(), True),\n",
							"    StructField(\"Medical_History\", StringType(), True),\n",
							"    StructField(\"Active_Flag\", BooleanType(), True)\n",
							"])"
						],
						"outputs": [],
						"execution_count": 13
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"rawPatientDF=spark.read.option(\"header\",True).schema(rawPatientDFSchema).csv(f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/raw/patient/{fileName}')"
						],
						"outputs": [],
						"execution_count": 25
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"avgAge=rawPatientDF.agg(F.avg('Age')).first()[0]"
						],
						"outputs": [],
						"execution_count": 17
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"rawPatientDF = rawPatientDF.withColumn(\"Name\", \n",
							"                   F.when(rawPatientDF.Name == 'None', None).otherwise(rawPatientDF.Name)) \\\n",
							"                   .withColumn(\"Gender\", \n",
							"                   F.when(rawPatientDF.Gender == 'None', None).otherwise(rawPatientDF.Gender)) \\\n",
							"                   .withColumn(\"Contact_Info\", \n",
							"                   F.when(rawPatientDF.Contact_Info == 'None', None).otherwise(rawPatientDF.Contact_Info)) \\\n",
							"                   .withColumn(\"Medical_History\", \n",
							"                   F.when(rawPatientDF.Medical_History == 'None', None).otherwise(rawPatientDF.Medical_History))"
						],
						"outputs": [],
						"execution_count": 19
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"refinedPatientDF1=rawPatientDF.fillna(0,['Patient_ID']).fillna('Unknown',['Name']).fillna(avgAge,['Age']) \\\n",
							".fillna('Unknown',['Gender']).fillna('000-000-0000',['Contact_Info']).fillna('Unknown',['Medical_History'])"
						],
						"outputs": [],
						"execution_count": 22
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"refinedPatientDF2=refinedPatientDF1.dropDuplicates(['Name','Age','Gender','Contact_Info'])"
						],
						"outputs": [],
						"execution_count": 24
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"refinedPatientDFFinal=refinedPatientDF2.withColumn('Contact_Info',F.concat(F.lit('+91 '),F.regexp_replace('Contact_Info','-',''))) \\\n",
							".withColumn('File_Name',F.lit(fileName))"
						],
						"outputs": [],
						"execution_count": 33
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": true
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"refinedPatientDFFinal.write.format('parquet').save(f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/refine/patient/table/')"
						],
						"outputs": [],
						"execution_count": 34
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"mssparkutils.fs.mkdirs(f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/archieve/patient/{currentDate}')"
						],
						"outputs": [],
						"execution_count": 12
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"mssparkutils.fs.mv(f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/raw/patient/{fileName}',f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/archieve/patient/{currentDate}/')"
						],
						"outputs": [],
						"execution_count": 13
					}
				]
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/Load_Refine_Treatments')]",
			"type": "Microsoft.Synapse/workspaces/notebooks",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"nbformat": 4,
				"nbformat_minor": 2,
				"bigDataPool": {
					"referenceName": "BigDataDev",
					"type": "BigDataPoolReference"
				},
				"sessionProperties": {
					"driverMemory": "28g",
					"driverCores": 4,
					"executorMemory": "28g",
					"executorCores": 4,
					"numExecutors": 2,
					"conf": {
						"spark.dynamicAllocation.enabled": "false",
						"spark.dynamicAllocation.minExecutors": "2",
						"spark.dynamicAllocation.maxExecutors": "2",
						"spark.autotune.trackingId": "7b2edefd-81d4-4b64-bdf0-d8bfe393de10"
					}
				},
				"metadata": {
					"saveOutput": true,
					"enableDebugMode": false,
					"kernelspec": {
						"name": "synapse_pyspark",
						"display_name": "Synapse PySpark"
					},
					"language_info": {
						"name": "python"
					},
					"a365ComputeOptions": {
						"id": "/subscriptions/2075028d-e3d3-4030-84e2-bb118eb5f397/resourceGroups/synapse_rg/providers/Microsoft.Synapse/workspaces/donflamingo/bigDataPools/BigDataDev",
						"name": "BigDataDev",
						"type": "Spark",
						"endpoint": "https://donflamingo.dev.azuresynapse.net/livyApi/versions/2019-11-01-preview/sparkPools/BigDataDev",
						"auth": {
							"type": "AAD",
							"authResource": "https://dev.azuresynapse.net"
						},
						"sparkVersion": "3.4",
						"nodeCount": 10,
						"cores": 4,
						"memory": 28,
						"automaticScaleJobs": false
					},
					"sessionKeepAliveTimeout": 30
				},
				"cells": [
					{
						"cell_type": "markdown",
						"metadata": {
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"<center><b> This notebook is used to create treatment table in refine layer</b></center>\n",
							"<table>\n",
							"<tr><th>Title</th><th>Description</th></tr>\n",
							"<tr><td>Creator</td><td>Aniket Belsare</td></tr>\n",
							"<tr><td>Reviewer</td><td>Ankit Negi</td></tr>\n",
							"<tr><td>Datasets Used</td><td>/raw/treatment/Treatment_YYYY_MM_DD.csv</td></tr>\n",
							"</table>"
						]
					},
					{
						"cell_type": "code",
						"metadata": {},
						"source": [
							"from datetime import datetime,timedelta\n",
							"from notebookutils import mssparkutils"
						],
						"outputs": [],
						"execution_count": 1
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"from pyspark.sql.types import StructType, StructField, StringType, IntegerType, BooleanType\n",
							"from pyspark.sql import functions as F"
						],
						"outputs": [],
						"execution_count": 2
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"currentDate=datetime.today()-timedelta(days=1)\n",
							"currentDate=currentDate.strftime('%Y-%m-%d')"
						],
						"outputs": [],
						"execution_count": 3
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"fileName='Treatment'+'_'+currentDate"
						],
						"outputs": [],
						"execution_count": 4
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"\n",
							"rawTreatmentDFSchema = StructType([\n",
							"    StructField(\"Treatment_ID\", IntegerType(), nullable=False),\n",
							"    StructField(\"Treatment_Type\", StringType(), nullable=True),\n",
							"    StructField(\"Cost\", IntegerType(), nullable=False)\n",
							"])"
						],
						"outputs": [],
						"execution_count": 7
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"rawTreatmentDF=spark.read.option(\"header\",True).schema(rawTreatmentDFSchema).csv(f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/raw/treatment/{fileName}')"
						],
						"outputs": [],
						"execution_count": 10
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"rawTreatmentDF = rawTreatmentDF.withColumn(\"Treatment_Type\", \n",
							"                   F.when(rawTreatmentDF.Treatment_Type == 'None', None).otherwise(rawTreatmentDF.Treatment_Type)) "
						],
						"outputs": [],
						"execution_count": 11
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"refinedTreatmentDF1=rawTreatmentDF.fillna('OutOfSyllabus',['Treatment_Type'])"
						],
						"outputs": [],
						"execution_count": 14
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"refinedTreatmentDFFinal=refinedTreatmentDF1.dropDuplicates(['Treatment_ID'])"
						],
						"outputs": [],
						"execution_count": 16
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": true
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"refinedTreatmentDFFinal.write.format('parquet').save(f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/refine/treatment/table/')"
						],
						"outputs": [],
						"execution_count": 17
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"mssparkutils.fs.mkdirs(f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/archieve/treatment/{currentDate}')"
						],
						"outputs": [],
						"execution_count": 18
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"mssparkutils.fs.mv(f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/raw/treatment/{fileName}',f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/archieve/treatment/{currentDate}/')"
						],
						"outputs": [],
						"execution_count": 19
					}
				]
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/Load_Refine_Visits')]",
			"type": "Microsoft.Synapse/workspaces/notebooks",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"nbformat": 4,
				"nbformat_minor": 2,
				"bigDataPool": {
					"referenceName": "BigDataDev",
					"type": "BigDataPoolReference"
				},
				"sessionProperties": {
					"driverMemory": "28g",
					"driverCores": 4,
					"executorMemory": "28g",
					"executorCores": 4,
					"numExecutors": 2,
					"conf": {
						"spark.dynamicAllocation.enabled": "false",
						"spark.dynamicAllocation.minExecutors": "2",
						"spark.dynamicAllocation.maxExecutors": "2",
						"spark.autotune.trackingId": "d56ee24c-ec6a-4770-9b9a-560529509459"
					}
				},
				"metadata": {
					"saveOutput": true,
					"enableDebugMode": false,
					"kernelspec": {
						"name": "synapse_pyspark",
						"display_name": "Synapse PySpark"
					},
					"language_info": {
						"name": "python"
					},
					"a365ComputeOptions": {
						"id": "/subscriptions/2075028d-e3d3-4030-84e2-bb118eb5f397/resourceGroups/synapse_rg/providers/Microsoft.Synapse/workspaces/donflamingo/bigDataPools/BigDataDev",
						"name": "BigDataDev",
						"type": "Spark",
						"endpoint": "https://donflamingo.dev.azuresynapse.net/livyApi/versions/2019-11-01-preview/sparkPools/BigDataDev",
						"auth": {
							"type": "AAD",
							"authResource": "https://dev.azuresynapse.net"
						},
						"sparkVersion": "3.4",
						"nodeCount": 10,
						"cores": 4,
						"memory": 28
					},
					"sessionKeepAliveTimeout": 30
				},
				"cells": [
					{
						"cell_type": "markdown",
						"metadata": {
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"<center><b> This notebook is used to create visits table in refine layer</b></center>\n",
							"<table>\n",
							"<tr><th>Title</th><th>Description</th></tr>\n",
							"<tr><td>Creator</td><td>Aniket Belsare</td></tr>\n",
							"<tr><td>Reviewer</td><td>Ankit Negi</td></tr>\n",
							"<tr><td>Datasets Used</td><td>/raw/visits/Visit_YYYY_MM_DD.csv</td></tr>\n",
							"</table>"
						]
					},
					{
						"cell_type": "code",
						"source": [
							"from datetime import datetime,timedelta\n",
							"from notebookutils import mssparkutils"
						],
						"outputs": [],
						"execution_count": 3
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"from pyspark.sql.types import StructType, StructField, StringType, IntegerType, BooleanType, DateType\n",
							"from pyspark.sql import functions as F"
						],
						"outputs": [],
						"execution_count": 9
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"currentDate=datetime.today()-timedelta(days=1)\n",
							"currentDate=currentDate.strftime('%Y-%m-%d')"
						],
						"outputs": [],
						"execution_count": 5
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"fileName='Visit'+'_'+currentDate"
						],
						"outputs": [],
						"execution_count": 6
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"\n",
							"rawVisitSchema = StructType([\n",
							"    StructField(\"Visit_ID\", IntegerType(), nullable=True),\n",
							"    StructField(\"Patient_ID\", IntegerType(), nullable=True),\n",
							"    StructField(\"Admission_Date\", DateType(), nullable=True),\n",
							"    StructField(\"Discharge_Date\", DateType(), nullable=True),\n",
							"    StructField(\"Doctor_ID\", IntegerType(), nullable=True),\n",
							"    StructField(\"Treatment_ID\", IntegerType(), nullable=True),\n",
							"    StructField(\"ICU_Stay\", StringType(), nullable=True),\n",
							"    StructField(\"Total_Cost\", IntegerType(), nullable=True)\n",
							"])"
						],
						"outputs": [],
						"execution_count": 10
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"rawVisitDF=spark.read.option(\"header\",True).schema(rawVisitSchema).csv(f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/raw/visits/{fileName}')"
						],
						"outputs": [],
						"execution_count": 12
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"rawVisitDF = rawVisitDF.withColumn(\"ICU_Stay\", \n",
							"                   F.when(rawVisitDF.ICU_Stay == 'None', None).otherwise(rawVisitDF.ICU_Stay))       "
						],
						"outputs": [],
						"execution_count": 15
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"refinedVisitDF1=rawVisitDF.fillna('No Record',['ICU_Stay'])"
						],
						"outputs": [],
						"execution_count": 16
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"refinedVisitDFFinal=refinedVisitDF1.dropDuplicates(['Visit_ID','Patient_ID'])"
						],
						"outputs": [],
						"execution_count": 20
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"refinedVisitDFFinal.write.format('parquet').save(f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/refine/visits/table/')"
						],
						"outputs": [],
						"execution_count": 21
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"mssparkutils.fs.mkdirs(f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/archieve/visits/{currentDate}')"
						],
						"outputs": [],
						"execution_count": 22
					},
					{
						"cell_type": "code",
						"metadata": {
							"jupyter": {
								"source_hidden": false,
								"outputs_hidden": false
							},
							"nteract": {
								"transient": {
									"deleting": false
								}
							}
						},
						"source": [
							"mssparkutils.fs.mv(f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/raw/visits/{fileName}',f'abfss://output@freefinalstorageaccount.dfs.core.windows.net/archieve/visits/{currentDate}/')"
						],
						"outputs": [],
						"execution_count": 23
					}
				]
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/sparkConfigurationForceIcebergPackage')]",
			"type": "Microsoft.Synapse/workspaces/sparkConfigurations",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"configs": {
					"spark.jars.packages": "spark.jars.packages org.apache.iceberg:iceberg-spark-runtime-3.4_2.12:1.6.1",
					"spark.sql.extensions": "spark.sql.extensions org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions"
				},
				"created": "2024-10-10T14:24:39.6420000+05:30",
				"createdBy": "savitabelsare348@gmail.com",
				"annotations": [],
				"configMergeRule": {
					"artifact.currentOperation.spark.jars.packages": "replace",
					"artifact.currentOperation.spark.sql.extensions": "replace"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/BigDataDev')]",
			"type": "Microsoft.Synapse/workspaces/bigDataPools",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"autoPause": {
					"enabled": true,
					"delayInMinutes": 5
				},
				"autoScale": {
					"enabled": true,
					"maxNodeCount": 3,
					"minNodeCount": 3
				},
				"nodeCount": 10,
				"nodeSize": "Small",
				"nodeSizeFamily": "MemoryOptimized",
				"sparkVersion": "3.4",
				"isComputeIsolationEnabled": false,
				"sessionLevelPackagesEnabled": false,
				"annotations": []
			},
			"dependsOn": [],
			"location": "eastasia"
		}
	]
}